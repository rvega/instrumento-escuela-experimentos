!function(a){"use strict";var b={};b.mixin=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])},a.EscuelaDeExperimentos=a.EscuelaDeExperimentos||{},a.EscuelaDeExperimentos.Utility=b}(this),function(a){"use strict";var b={};b.initInstrumentoMonofonico=function(a){var b=a||{};this.secuencia=b.secuencia||[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.notas=b.notas||[100,200,300,400,500,600,700,800,900,1e3],this.audioGraph=b.audioGraph,this.tiempoMirarFuturo=.5,this.tiempoNotaActual=0,this.notaActual=0,this.tiempoNotaProxima=0},b.tocarNota=function(){console.error('MixinInstrumentoMonofonico: Todos los instrumentos deben implementar el método "tocarNota"')},b.programarNotas=function(a){for(var b,c=this.audioGraph.tempo,d=60/c;this.tiempoNotaProxima<a+this.tiempoMirarFuturo;)0!==this.secuencia[this.notaActual]&&(b=this.notas[this.secuencia[this.notaActual]],this.tocarNota(this.tiempoNotaProxima,d,b)),this.tiempoNotaActual=this.tiempoNotaProxima,this.tiempoNotaProxima+=d,this.notaActual++,this.notaActual===this.secuencia.length&&(this.notaActual=0)},b.conectar=function(){console.error('MixinInstrumentoMonofonico: Todos los instrumentos deben implementar el método "conectar"')},a.EscuelaDeExperimentos=a.EscuelaDeExperimentos||{},a.EscuelaDeExperimentos.MixinInstrumentoMonofonico=b}(this),function(a){"use strict";var b=function(a){var b=a||{};this.oscilador=null,this.gain=null,this.ataque=b.ataque||.002,this.descarga=b.descarga||.2,this.initInstrumentoMonofonico(a)};EscuelaDeExperimentos.Utility.mixin(b.prototype,EscuelaDeExperimentos.MixinInstrumentoMonofonico),b.prototype.tocarNota=function(a,b,c){this.oscilador.frequency.setValueAtTime(c,a),this.gain.gain.setValueAtTime(0,a),this.gain.gain.linearRampToValueAtTime(1,a+this.ataque),this.gain.gain.linearRampToValueAtTime(0,a+.5*b+this.descarga)},b.prototype.conectar=function(a){var b=this.audioGraph.audioContext;this.oscilador=b.createOscillator(),this.oscilador.type="saw",this.oscilador.frequency.value=220,this.oscilador.start(),this.gain=b.createGain(),this.gain.gain.value=0,this.oscilador.connect(this.gain),this.gain.connect(a)},a.EscuelaDeExperimentos=a.EscuelaDeExperimentos||{},a.EscuelaDeExperimentos.InstrumentoBajo=b}(this),function(a){"use strict";var b=function(a){var b=a||{};this.audioContext=b.audioContext||new AudioContext,this.tempo=b.tempo||120,this.periodoTick=b.periodoTick||.05,this.instrumentos={};var c=new EscuelaDeExperimentos.InstrumentoBajo({audioGraph:this});c.conectar(this.audioContext.destination),this.instrumentos.bajo=c,setInterval(this.tick.bind(this),1e3*this.periodoTick)};b.prototype.tick=function(){var a=this.audioContext.currentTime;for(var b in this.instrumentos)this.instrumentos[b].programarNotas(a)},a.EscuelaDeExperimentos=a.EscuelaDeExperimentos||{},a.EscuelaDeExperimentos.AudioGraph=b}(this),function(a){"use strict";var b=function(a){var b=a||{};this.superView=b.superView,this.audioInstrumento=b.audioInstrumento,this.botones=[],this.columnaDestacada=0,this.dibujar(),this.destacarColumna(0,!0)};b.prototype.clickBoton=function(a){var b=a.target;b.activo?(b.fill("#FFFFFF"),b.activo=!1):(b.fill("#333333"),b.activo=!0),b.draw()},b.prototype.polar2cart=function(a,b){var c=this.superView.ancho;a-=90,a*=-1;var d=c/2+b*Math.cos(a*Math.PI/180),e=c/2-b*Math.sin(a*Math.PI/180);return{x:d,y:e}},b.prototype.dibujar=function(){var a=this.superView.stage,b=new Kinetic.Layer,c=this.superView.ancho,d=this.audioInstrumento.notas.length,e=c/10,f=(c/2-e)/d;console.log(f);for(var g=.8*f,h=this.audioInstrumento.secuencia.length,i=360/h,j=.9*i,k=0;h>k;k++){for(var l=[],m=0;d>m;m++){var n=m*f,o=k*i,p=this.polar2cart(o-j/2,e+n+g),q=this.polar2cart(o-j/4,e+n+g),r=this.polar2cart(o,e+n+g),s=this.polar2cart(o+j/4,e+n+g),t=this.polar2cart(o+j/2,e+n+g),u=this.polar2cart(o+j/2,e+n),v=this.polar2cart(o+j/4,e+n),w=this.polar2cart(o,e+n),x=this.polar2cart(o-j/4,e+n),y=this.polar2cart(o-j/2,e+n),z=new Kinetic.Line({fill:"white",stroke:"red",strokeWidth:1,closed:!0,points:[p.x,p.y,q.x,q.y,r.x,r.y,s.x,s.y,t.x,t.y,u.x,u.y,v.x,v.y,w.x,w.y,x.x,x.y,y.x,y.y]});z.columna=m,z.fila=k,z.activo=!1,z.on("mousedown",this.clickBoton.bind(this)),b.add(z),l.push(z)}this.botones.push(l)}a.add(b)},b.prototype.destacarColumna=function(a,b){for(var c=this.botones[a],d=c.length,e=0;d>e;e++){var f=c[e];f.fill(f.activo&&b===!0?"#553333":f.activo||b!==!0?f.activo&&!b?"#333333":"#FFFFFF":"#FF0000"),f.draw()}},b.prototype.update=function(a){var b=this.audioInstrumento,c=60/b.audioGraph.tempo,d=c*b.secuencia.length,e=a%d,f=Math.floor(e/c);f!==this.columnaDestacada&&(this.destacarColumna(this.columnaDestacada,!1),this.destacarColumna(f,!0),this.columnaDestacada=f)},a.EscuelaDeExperimentos=a.EscuelaDeExperimentos||{},a.EscuelaDeExperimentos.InstrumentoBajoView=b}(this),function(a){"use strict";var b=function(a){var b=a||{};this.audioGraph=b.audioGraph,this.stage=null,this.subViews={},this.htmlContainer=b.htmlContainer,this.ancho=b.ancho||window.innerWidth,this.alto=b.alto||window.innerHeight,this.initStage(),this.initSubviews()};b.prototype.initStage=function(){this.stage=new Kinetic.Stage({container:this.htmlContainer,width:this.ancho,height:this.alto})},b.prototype.initSubviews=function(){var a=new EscuelaDeExperimentos.InstrumentoBajoView({audioInstrumento:this.audioGraph.instrumentos.bajo,superView:this});this.subViews.bajo=a,this.update()},b.prototype.update=function(){var a=this.audioGraph.audioContext.currentTime;for(var b in this.subViews)this.subViews[b].update(a);window.requestAnimationFrame(this.update.bind(this))},a.EscuelaDeExperimentos=a.EscuelaDeExperimentos||{},a.EscuelaDeExperimentos.MainView=b}(this),function(a){"use strict";a.EscuelaDeExperimentos=a.EscuelaDeExperimentos||{};var b=function(a){var b=a||{};return b.htmlContainer?(this.audioGraph=new EscuelaDeExperimentos.AudioGraph,void(this.mainView=new EscuelaDeExperimentos.MainView({audioGraph:this.audioGraph,htmlContainer:b.htmlContainer}))):void console.error("EscuelaDeExperimentos.App(): Necesito un elemento html donde dibujar.")};a.EscuelaDeExperimentos.App=b}(this);